<!DOCTYPE html>
<html lang="pt-br">

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8" />
  <title>Calendário Pokémon GO</title>
</head>

<body>
  <!-- Menu carregado dinamicamente -->
  <div id="menu"></div>

  <!-- Script para carregar o menu -->
  <script>
    fetch('../menu.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu').innerHTML = html;
      });
  </script>

  <!-- Cabeçalho com título e mês atual -->
  <header>
    <h1>Calendário de Eventos Pokémon GO</h1>
    <p id="mesAno"></p>
  </header>

  <!-- Controles para mudar o mês e exibir destaques -->
  <div class="controls">
    <button onclick="mudarMes(-1)">&#8592; Mês Anterior</button>

    <!-- Container para os destaques (season + ticket do mês) -->
    <div id="destaquesMes" class="destaques-container">
      <div class="evento-destaque" id="eventoSeason" style="display: none;"></div>
      <div class="evento-destaque" id="go_pass" style="display: none;"></div>
    </div>

    <button onclick="mudarMes(1)">Próximo Mês &#8594;</button>
  </div>

  <!-- Caixa de busca de eventos -->
  <div style="text-align: center; margin: 10px;">
    <input type="text" id="buscaEvento" placeholder="🔍 Buscar evento..." style="padding: 6px; width: 220px;">
    <button id="btnBuscar" style="padding: 6px 12px; margin-left: 6px; cursor: pointer;">Buscar</button>
  </div>

  <!-- Filtro por categoria -->
  <div id="filtro-categorias" style="padding: 10px; text-align: center;"></div>

  <!-- Labels dos dias da semana -->
  <div class="week-labels">
    <div>Dom</div>
    <div>Seg</div>
    <div>Ter</div>
    <div>Qua</div>
    <div>Qui</div>
    <div>Sex</div>
    <div>Sáb</div>
  </div>

  <!-- Container do calendário (dias gerados por JS) -->
  <div class="grid-container" id="calendario">    <!-- Dias preenchidos pelo JS -->
  </div>

  <script>
    // Mapeamento dos nomes amigáveis das categorias
    const nomesCategorias = {
      events: 'Eventos',
      research: 'Pesquisas',
      community_day: 'Dias da Comunidade',
      raids: 'Raids',
      raid_hour: 'Horas Lendárias',
      max_monday: 'Segundas Max',
      spotlights: 'Hora do Holofote'
      // adicione outras categorias que usar
    };

    // Carregar eventos do mês para o calendário (várias categorias)
    const categorias = ['events', 'research', 'community_day', 'raids', 'raid_hour', 'max_monday', 'spotlights'];

    // Data atual que o calendário mostra
    let dataAtual = new Date();    // Objeto para armazenar eventos por data
    let events = {};

    // Função para formatar datas (dd/mm e hora:min)
    function formatarData(iso) {
      const d = new Date(iso);
      return d.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
      
      // Gera os checkbox de filtro de categorias
      function gerarCheckboxesCategorias(listaCategorias) {
        const container = document.getElementById('filtro-categorias');
        if (!container) {
          console.warn("Div de filtro-categorias não encontrada.");
          return;
        }

        container.innerHTML = '';

        listaCategorias.forEach(cat => {
          const nomeAmigavel = nomesCategorias[cat] || cat;
      
          const label = document.createElement('label');
          label.style.marginRight = '12px';
          label.style.display = 'inline-block';
          label.style.color = '#fff';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = cat;
          checkbox.checked = true;
          checkbox.classList.add('filtro-categoria');
          checkbox.addEventListener('change', aplicarFiltroCategorias);

          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(' ' + nomeAmigavel));
          container.appendChild(label);
        });
      }

      // Aplica o filtro baseado nos checkboxes marcados
      function aplicarFiltroCategorias() {
        const selecionadas = Array.from(document.querySelectorAll('#filtro-categorias input[type="checkbox"]:checked'))
        .map(cb => cb.value);

        document.querySelectorAll(".event").forEach(el => {
          const categoria = el.getAttribute("data-categoria");
          if (selecionadas.includes(categoria)) {
            el.style.display = "";
          } else {
            el.style.display = "none";
          }
        });
      }

    // Função para carregar eventos do arquivo JSON
    async function carregarEvents() {
    try {
      let dados;

      if (typeof Android !== 'undefined' && typeof Android.getJson === 'function') {
        // No app Android, usa a interface Java para obter JSON
        try {
          const json = Android.getJson();
          dados = JSON.parse(json);
        } catch (e) {
          console.error('Erro ao obter JSON via Android.getJson():', e);
        }
      }

      if (!dados) {
        // No navegador (ou se deu erro no Android), tenta carregar via fetch
        try {
          const resposta = await fetch('calendario_eventos_pokemongo.json');
          if (!resposta.ok) throw new Error('Erro ao carregar JSON via fetch');
          dados = await resposta.json();
        } catch (e) {
          console.error('Erro ao carregar JSON via fetch:', e);
          // Aqui pode tratar erro, exibir mensagem, etc.
          return;
        }
      }

        dadosGlobais = dados; // armazena para busca global

        events = {};

        const anoStr = String(dataAtual.getFullYear());
        const mesStr = String(dataAtual.getMonth() + 1).padStart(2, '0');

        const primeiroDiaMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), 1);
        const ultimoDiaMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 0);

        // Exibir destaque da season
        const divSeason = document.getElementById('eventoSeason');
        divSeason.style.display = 'none';

        if (dados[anoStr] && dados[anoStr].season) {
          const seasonAtiva = dados[anoStr].season.find(ev => {
            const inicio = new Date(ev.inicio);
            const fim = new Date(ev.fim);
            return fim >= primeiroDiaMes && inicio <= ultimoDiaMes;
          });
          if (seasonAtiva) {
            divSeason.style.display = 'inline-block';
            if (seasonAtiva.link) {
              divSeason.innerHTML = `
                <a href="${seasonAtiva.link}" target="_blank" style="color: inherit; text-decoration: none;">
                  <img src="${seasonAtiva.img}" alt="">
                  <strong>${seasonAtiva.titulo}</strong><br>
                  <span class="horario">(${formatarData(seasonAtiva.inicio)} – ${formatarData(seasonAtiva.fim)})</span>
                </a>
              `;
            } else {
              divSeason.innerHTML = `
                <img src="${seasonAtiva.img}" alt="">
                <strong>${seasonAtiva.titulo}</strong><br>
                <span class="horario">(${formatarData(seasonAtiva.inicio)} – ${formatarData(seasonAtiva.fim)})</span>
              `;
            }
          }
        }

        // Exibir destaque do ticket do mês
        const divTicket = document.getElementById('go_pass');
        divTicket.style.display = 'none';

        if (
          dados[anoStr] &&
          dados[anoStr].meses &&
          dados[anoStr].meses[mesStr] &&
          dados[anoStr].meses[mesStr].go_pass
        ) {
          const ticket = dados[anoStr].meses[mesStr].go_pass;
          const inicioMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), 1);
          const fimMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 0);

          if (ticket.inicio && ticket.fim) {
            const inicio = new Date(ticket.inicio);
            const fim = new Date(ticket.fim);

            if (fim >= inicioMes && inicio <= fimMes) {
              divTicket.style.display = 'inline-block';

              if (ticket.link) {
                divTicket.innerHTML = `
                  <a href="${ticket.link}" target="_blank" style="color: inherit; text-decoration: none;">
                    <img src="${ticket.img}" alt="">
                    <strong>${ticket.titulo}</strong><br>
                    <span class="horario">(${formatarData(ticket.inicio)} – ${formatarData(ticket.fim)})</span>
                  </a>
                `;
              } else {
                divTicket.innerHTML = `
                  <img src="${ticket.img}" alt="">
                  <strong>${ticket.titulo}</strong><br>
                  <span class="horario">(${formatarData(ticket.inicio)} – ${formatarData(ticket.fim)})</span>
                `;
              }
            }
          }
        }

        if (dados[anoStr] && dados[anoStr].meses) {
          categorias.forEach(categoria => {
            for (const mesArmazenado in dados[anoStr].meses) {
              const lista = dados[anoStr].meses[mesArmazenado][categoria];
              if (!Array.isArray(lista)) continue;

              lista.forEach(ev => {
                function parseDataLocal(isoDate) {
                  const [ano, mes, dia] = isoDate.split('T')[0].split('-');
                  return new Date(Number(ano), Number(mes) - 1, Number(dia));
                }

                let dataAtualEvento = parseDataLocal(ev.data_inicio);
                const dataFimEvento = parseDataLocal(ev.data_fim);

                // Verifica se o evento cruza o mês atual
                const inicioMesAtual = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), 1);
                const fimMesAtual = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 0);

                if (dataFimEvento < inicioMesAtual || dataAtualEvento > fimMesAtual) {
                  // Evento não aparece neste mês
                  return;
                }

                // Percorre todos os dias do evento
                while (dataAtualEvento <= dataFimEvento) {
                  const ano = dataAtualEvento.getFullYear();
                  const mes = String(dataAtualEvento.getMonth() + 1).padStart(2, '0');
                  const dia = String(dataAtualEvento.getDate()).padStart(2, '0');
                  const dataStr = `${ano}-${mes}-${dia}`;

                  // Só adiciona o evento se o dia estiver dentro do mês visível
                  if (
                    dataAtualEvento >= inicioMesAtual &&
                    dataAtualEvento <= fimMesAtual
                    ) {
                      const mostrarHorario = (() => {
                        if (ev.data_inicio === ev.data_fim) {
                          return `(${ev.hora_inicio} – ${ev.hora_fim})`;
                        } else if (dataStr === ev.data_inicio) {
                          return `(Inicio:${ev.hora_inicio})`;
                        } else if (dataStr === ev.data_fim) {
                          return `(Termina:${ev.hora_fim})`;
                        } else {
                          return '';
                        }
                      })();

                      if (!events[dataStr]) events[dataStr] = [];

                      events[dataStr].push({
                        texto: {
                          titulo: ev.titulo,
                          horario: mostrarHorario
                        },
                        img: ev.img || 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/event.png',
                        link: ev.link || null,
                        categoria: categoria
                      });
                    }

                    dataAtualEvento.setDate(dataAtualEvento.getDate() + 1);
                  }
                });
              }
            });
          }


          function formatarCategoria(categoria) {
            return categoria.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          }

          renderizarCalendario();
        } catch (erro) {
          console.error('Erro ao carregar eventos:', erro);
        }
      }

      // Função para renderizar o calendário
      function renderizarCalendario() {
        const container = document.getElementById('calendario');
        const mesAno = document.getElementById('mesAno');
        container.innerHTML = '';

        const ano = dataAtual.getFullYear();
        const mes = dataAtual.getMonth();

        // Exibe o mês e ano no cabeçalho
        mesAno.textContent = dataAtual.toLocaleDateString('pt-BR', {
          month: 'long',
          year: 'numeric'
        });

        const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();

        // Espaços vazios antes do primeiro dia do mês (para alinhar os dias da semana)
        for (let i = 0; i < primeiroDiaSemana; i++) {
          container.appendChild(document.createElement('div'));
        }

        // Criar células para cada dia do mês
        for (let dia = 1; dia <= diasNoMes; dia++) {
          const dataLocal = new Date(ano, mes, dia);
          const anoStr = dataLocal.getFullYear();
          const mesStr = String(dataLocal.getMonth() + 1).padStart(2, '0');
          const diaStr = String(dataLocal.getDate()).padStart(2, '0');
          const dataStr = `${anoStr}-${mesStr}-${diaStr}`;
          const celula = document.createElement('div');
          celula.className = 'day-cell';

          const rotulo = document.createElement('div');
          rotulo.className = 'day-label';
          rotulo.textContent = dia;
          celula.appendChild(rotulo);

          // Verifica se é o dia atual e aplica classe especial
          const hoje = new Date();
          if (
            dataLocal.getDate() === hoje.getDate() &&
            dataLocal.getMonth() === hoje.getMonth() &&
            dataLocal.getFullYear() === hoje.getFullYear()
          ) {
            celula.classList.add('hoje');
          }

        // Adicionar eventos do dia, se houver
        if (events[dataStr]) {
          events[dataStr].forEach(ev => {
            const div = document.createElement('div');
            div.classList.add('event');      // para aplicar o filtro
            div.setAttribute('data-categoria', ev.categoria);      // para o filtro saber a qual categoria pertence

            if (ev.link) {
              div.innerHTML = `
                <a href="${ev.link}" target="_blank" style="color: inherit; text-decoration: none;">
                  <img src="${ev.img}" alt="">
                  <div><strong>${ev.texto.titulo}</strong></div>
                  <div style="font-size: 10px; color: #ccc;">${ev.texto.horario}</div>
                </a>
              `;
            } else {
              div.innerHTML = `
                <img src="${ev.img}" alt="">
                <div><strong>${ev.texto.titulo}</strong></div>
                <div style="font-size: 10px; color: #ccc;">${ev.texto.horario}</div>
              `;
            }

            celula.appendChild(div);
          });
        }

        container.appendChild(celula);
      }
    }

    // Função para mudar o mês e recarregar eventos
    function mudarMes(delta) {
      dataAtual.setMonth(dataAtual.getMonth() + delta);
      carregarEvents();
    }

    // Busca global simples: encontra o mês e ano do primeiro evento que contém o termo buscado
    function buscarEventoGlobalSimples(termoBusca) {
      termoBusca = termoBusca.toLowerCase();

      for (const ano in dadosGlobais) {
        if (!dadosGlobais.hasOwnProperty(ano)) continue;
        const meses = dadosGlobais[ano].meses;
        if (!meses) continue;

        for (const mes in meses) {
          if (!meses.hasOwnProperty(mes)) continue;

          // Categorias possíveis
          const categorias = ['go_pass', 'events', 'research', 'community_day', 'raids', 'raid_hour', 'max_monday', 'spotlights'];

          for (const cat of categorias) {
            const lista = meses[mes][cat];
            if (!lista) continue;

            if (Array.isArray(lista)) {
			  for (const ev of lista) {
			    if (!ev.titulo) continue;
				if (ev.titulo.toLowerCase().includes(termoBusca)) {
				  // Retorna o ano e mês do evento encontrado
				  return { ano: Number(ano), mes: Number(mes) - 1 }; // mês zero-based para Date
				}
			  }
			}
		  }
        }
      }
    return null; // Não achou
  }

  // Evento click do botão Buscar
  document.getElementById('btnBuscar').addEventListener('click', () => {
    const termoBusca = document.getElementById('buscaEvento').value.trim();
    if (termoBusca.length === 0) return; // Nenhum termo, não faz nada

    const resultado = buscarEventoGlobalSimples(termoBusca);
    if (resultado) {
      dataAtual = new Date(resultado.ano, resultado.mes, 1);
      carregarEvents();
    }
  });

    // Carrega os eventos na inicialização
    carregarEvents().then(() => {
      gerarCheckboxesCategorias(categorias);
      aplicarFiltroCategorias();
    });

  </script>

  <!-- Modal com QR Code PIX -->
  <div id="pix-modal" style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: #1f1f1f;
    border: 2px solid #444;
    padding: 10px;
    border-radius: 12px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    max-width: 170px;
    text-align: center;
    color: #fff;
    font-family: Arial, sans-serif;
  ">
      <div style="text-align: right;">
        <button onclick="document.getElementById('pix-modal').style.display='none'" style="
        background: transparent;
        border: none;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
        line-height: 1;
      ">✕</button>
      </div>
      <p style="margin-top: 0; font-size: 14px;">Ajude a melhorar o site <br>fazendo uma doação.</p>
      <img src="https://static.wixstatic.com/media/547906_18d83fe6ead44cbdb360b0658479ea09~mv2.jpeg" alt="QR Code PIX"
        style="width: 100%; border-radius: 8px;">
    </div>

  </body>
</html>
